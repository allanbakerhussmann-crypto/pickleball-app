rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isClubAdmin(clubId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/clubs/$(clubId)) &&
        request.auth.uid in get(/databases/$(database)/documents/clubs/$(clubId)).data.admins;
    }
    
    function isClubMember(clubId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/clubs/$(clubId)) &&
        (request.auth.uid in get(/databases/$(database)/documents/clubs/$(clubId)).data.members ||
         request.auth.uid in get(/databases/$(database)/documents/clubs/$(clubId)).data.admins);
    }
    
    function isTournamentOrganizer(tournamentId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/tournaments/$(tournamentId)) &&
        request.auth.uid == get(/databases/$(database)/documents/tournaments/$(tournamentId)).data.createdByUserId;
    }
    
    function isLeagueAdmin(leagueId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/leagues/$(leagueId)) &&
        request.auth.uid == get(/databases/$(database)/documents/leagues/$(leagueId)).data.createdByUserId;
    }
    
    // ============================================
    // PLATFORM SETTINGS (Admin only)
    // ============================================
    
    match /platformSettings/{docId} {
      allow read: if isAuthenticated();
      // Write restricted to app admins (implement via Cloud Functions)
      allow write: if false;
    }
    
    // ============================================
    // WALLET COLLECTIONS
    // ============================================
    
    // Wallets - users can read their own, clubs can read member wallets
    match /wallets/{walletId} {
      allow read: if isAuthenticated() && (
        resource.data.odUserId == request.auth.uid ||
        isClubAdmin(resource.data.odClubId)
      );
      // All writes go through Cloud Functions for security
      allow write: if false;
    }
    
    // ============================================
    // TRANSACTION COLLECTIONS
    // ============================================
    
    // Transactions - users see their own, clubs see their transactions
    match /transactions/{transactionId} {
      allow read: if isAuthenticated() && (
        resource.data.odUserId == request.auth.uid ||
        (resource.data.odClubId != null && isClubAdmin(resource.data.odClubId)) ||
        (resource.data.tournamentId != null && isTournamentOrganizer(resource.data.tournamentId)) ||
        (resource.data.leagueId != null && isLeagueAdmin(resource.data.leagueId))
      );
      // All writes go through Cloud Functions
      allow write: if false;
    }
    
    // ============================================
    // PAYMENT COLLECTIONS
    // ============================================
    
    // Payments - similar access to transactions
    match /payments/{paymentId} {
      allow read: if isAuthenticated() && (
        resource.data.odUserId == request.auth.uid ||
        (resource.data.odClubId != null && isClubAdmin(resource.data.odClubId)) ||
        (resource.data.tournamentId != null && isTournamentOrganizer(resource.data.tournamentId)) ||
        (resource.data.leagueId != null && isLeagueAdmin(resource.data.leagueId))
      );
      allow write: if false;
    }
    
    // Refunds - users see their own, admins see club refunds
    match /refunds/{refundId} {
      allow read: if isAuthenticated() && (
        resource.data.odUserId == request.auth.uid ||
        (resource.data.odClubId != null && isClubAdmin(resource.data.odClubId))
      );
      // Users can request refunds (create), processing via Cloud Functions
      allow create: if isAuthenticated() && 
        request.resource.data.requestedByUserId == request.auth.uid;
      allow update, delete: if false;
    }
    
    // ============================================
    // ANNUAL PASSES
    // ============================================
    
    match /annualPasses/{passId} {
      allow read: if isAuthenticated() && (
        resource.data.odUserId == request.auth.uid ||
        isClubAdmin(resource.data.odClubId)
      );
      allow write: if false;
    }
    
    // ============================================
    // PAYOUT COLLECTIONS
    // ============================================
    
    match /payouts/{payoutId} {
      allow read: if isAuthenticated() && isClubAdmin(resource.data.odClubId);
      allow write: if false;
    }
    
    // ============================================
    // RECEIPT COLLECTIONS
    // ============================================
    
    match /receipts/{receiptId} {
      allow read: if isAuthenticated() && (
        resource.data.odUserId == request.auth.uid ||
        (resource.data.odClubId != null && isClubAdmin(resource.data.odClubId))
      );
      allow write: if false;
    }
    
    // ============================================
    // ACCOUNT COLLECTIONS
    // ============================================
    
    // User Accounts - users see their own financial summary
    match /userAccounts/{userId} {
      allow read: if isOwner(userId);
      allow write: if false;
    }
    
    // Club Accounts - club admins see club finances
    match /clubAccounts/{clubId} {
      allow read: if isAuthenticated() && isClubAdmin(clubId);
      allow write: if false;
    }
    
    // Tournament Accounts - organizers see tournament finances
    match /tournamentAccounts/{tournamentId} {
      allow read: if isAuthenticated() && isTournamentOrganizer(tournamentId);
      allow write: if false;
    }
    
    // League Accounts - league admins see league finances
    match /leagueAccounts/{leagueId} {
      allow read: if isAuthenticated() && isLeagueAdmin(leagueId);
      allow write: if false;
    }
    
    // ============================================
    // REPORT COLLECTIONS
    // ============================================
    
    match /reports/{reportId} {
      allow read: if isAuthenticated() && (
        resource.data.generatedByUserId == request.auth.uid ||
        (resource.data.odUserId != null && resource.data.odUserId == request.auth.uid) ||
        (resource.data.odClubId != null && isClubAdmin(resource.data.odClubId)) ||
        (resource.data.tournamentId != null && isTournamentOrganizer(resource.data.tournamentId)) ||
        (resource.data.leagueId != null && isLeagueAdmin(resource.data.leagueId))
      );
      allow write: if false;
    }
    
    match /scheduledReports/{scheduleId} {
      allow read: if isAuthenticated() && (
        resource.data.createdByUserId == request.auth.uid ||
        (resource.data.odClubId != null && isClubAdmin(resource.data.odClubId))
      );
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        resource.data.createdByUserId == request.auth.uid;
    }
    
    match /exportRequests/{exportId} {
      allow read: if isAuthenticated() && 
        resource.data.requestedByUserId == request.auth.uid;
      allow create: if isAuthenticated() && 
        request.resource.data.requestedByUserId == request.auth.uid;
      allow update, delete: if false;
    }
    
    // ============================================
    // AUDIT LOG COLLECTIONS
    // ============================================
    
    // Payment audit logs - strict access
    match /paymentAuditLogs/{logId} {
      // Only platform admins can read audit logs directly
      // Users access via reports/exports
      allow read: if false;
      allow write: if false;
    }
    
    // General audit logs (existing)
    match /audit_logs/{logId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // ============================================
    // CORE COLLECTIONS (SECURED)
    // ============================================

    // Users - SECURED: Users can only modify their own profile
    match /users/{userId} {
      // Anyone authenticated can read profiles (needed for player search, team display)
      allow read: if isAuthenticated();
      // Users can only write their own profile
      // IMPORTANT: Role changes (admin, organizer) should go through Cloud Functions
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) &&
        // Prevent users from self-promoting to admin
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['isAppAdmin', 'isRootAdmin']));
      allow delete: if false; // Users cannot delete profiles
    }

    // Meetups collection - SECURED
    match /meetups/{meetupId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.createdByUserId == request.auth.uid;

      match /rsvps/{odUserId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && request.auth.uid == odUserId;
      }
    }

    // Tournaments - SECURED: Only organizers can modify
    match /tournaments/{tournamentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isTournamentOrganizer(tournamentId);

      match /divisions/{divisionId} {
        allow read: if isAuthenticated();
        allow write: if isTournamentOrganizer(tournamentId);
      }
      match /teams/{teamId} {
        allow read: if isAuthenticated();
        // Teams can be created by authenticated users (registration)
        allow create: if isAuthenticated();
        // Only organizers or team members can update
        allow update: if isTournamentOrganizer(tournamentId) ||
          (isAuthenticated() && request.auth.uid in resource.data.playerIds);
        allow delete: if isTournamentOrganizer(tournamentId);
      }
      match /matches/{matchId} {
        allow read: if isAuthenticated();
        allow write: if isTournamentOrganizer(tournamentId);
      }
      match /courts/{courtId} {
        allow read: if isAuthenticated();
        allow write: if isTournamentOrganizer(tournamentId);
      }
      match /scoreSubmissions/{subId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isTournamentOrganizer(tournamentId);
      }
    }

    // Clubs - SECURED: Only admins can modify club settings
    match /clubs/{clubId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Only club admins or the creator can update/delete the club
      allow update: if isClubAdmin(clubId) ||
        (isAuthenticated() && resource.data.createdByUserId == request.auth.uid);
      allow delete: if isAuthenticated() && resource.data.createdByUserId == request.auth.uid;

      match /joinRequests/{requestId} {
        allow read: if isAuthenticated();
        // Users can create their own join requests
        allow create: if isAuthenticated();
        // Only club admins can approve/deny requests
        allow update, delete: if isClubAdmin(clubId);
      }
      match /courts/{courtId} {
        allow read: if isAuthenticated();
        allow write: if isClubAdmin(clubId);
      }
      match /bookings/{bookingId} {
        allow read: if isAuthenticated();
        // Members can create bookings
        allow create: if isClubMember(clubId);
        // Users can update/cancel their own bookings, admins can manage all
        allow update, delete: if isClubAdmin(clubId) ||
          (isAuthenticated() && resource.data.bookedByUserId == request.auth.uid);
      }

      // Club branding settings
      match /branding/{brandingId} {
        allow read: if isAuthenticated();
        allow write: if isClubAdmin(clubId);
      }

      // Club payout settings
      match /payoutSettings/{settingsId} {
        allow read: if isClubAdmin(clubId);
        allow write: if isClubAdmin(clubId);
      }
    }

    // Leagues - SECURED: Only league admins can modify
    match /leagues/{leagueId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isLeagueAdmin(leagueId);

      match /members/{memberId} {
        allow read: if isAuthenticated();
        // Users can join leagues (create their membership)
        allow create: if isAuthenticated();
        // Only league admin or the member themselves can update
        allow update: if isLeagueAdmin(leagueId) || isOwner(memberId);
        allow delete: if isLeagueAdmin(leagueId);
      }
      match /matches/{matchId} {
        allow read: if isAuthenticated();
        allow write: if isLeagueAdmin(leagueId);
      }
      match /challenges/{challengeId} {
        allow read: if isAuthenticated();
        // Users can create challenges
        allow create: if isAuthenticated();
        // Participants or admins can update
        allow update: if isLeagueAdmin(leagueId) ||
          (isAuthenticated() && (
            resource.data.challengerId == request.auth.uid ||
            resource.data.challengedId == request.auth.uid
          ));
        allow delete: if isLeagueAdmin(leagueId);
      }
    }

    // Tournament Registrations - SECURED
    match /tournament_registrations/{regId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Only the registrant or tournament organizer can update/cancel
      allow update, delete: if isAuthenticated() &&
        (resource.data.odUserId == request.auth.uid ||
         isTournamentOrganizer(resource.data.tournamentId));
    }

    // Partner Invites - SECURED
    match /partnerInvites/{inviteId} {
      allow read: if isAuthenticated() && (
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid
      );
      allow create: if isAuthenticated();
      // Only sender or recipient can update (accept/decline)
      allow update: if isAuthenticated() && (
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid
      );
      allow delete: if isAuthenticated() && resource.data.fromUserId == request.auth.uid;
    }

    // Social Events - SECURED
    match /social_events/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.createdByUserId == request.auth.uid;
    }

    // Audit logs - only create allowed
    match /team_creation_audit/{auditId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // Teams (root level) - SECURED
    match /teams/{teamId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Only team members or related organizers can update
      allow update: if isAuthenticated() && (
        request.auth.uid in resource.data.playerIds ||
        isTournamentOrganizer(resource.data.tournamentId)
      );
      allow delete: if isTournamentOrganizer(resource.data.tournamentId);
    }

    // Competitions - SECURED
    match /competitions/{competitionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.createdByUserId == request.auth.uid;

      match /entries/{entryId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAuthenticated() && (
          resource.data.odUserId == request.auth.uid ||
          get(/databases/$(database)/documents/competitions/$(competitionId)).data.createdByUserId == request.auth.uid
        );
      }
      match /matches/{matchId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() &&
          get(/databases/$(database)/documents/competitions/$(competitionId)).data.createdByUserId == request.auth.uid;
      }
    }

    match /competitionEntries/{entryId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.odUserId == request.auth.uid;
    }

    // Standings - read only for users, write via Cloud Functions
    match /standings/{standingId} {
      allow read: if isAuthenticated();
      allow write: if false; // Updated by Cloud Functions only
    }

    // Match Score Submissions - SECURED
    match /matchScoreSubmissions/{submissionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Only the submitter can update their submission
      allow update: if isAuthenticated() && resource.data.submittedByUserId == request.auth.uid;
      allow delete: if false;
    }

    // Organizer Requests - SECURED
    match /organizerRequests/{requestId} {
      allow read: if isAuthenticated() && resource.data.odUserId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.odUserId == request.auth.uid;
      allow update, delete: if false; // Admin actions via Cloud Functions
    }
  }
}
