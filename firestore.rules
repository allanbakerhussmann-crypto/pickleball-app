rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isClubAdmin(clubId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/clubs/$(clubId)) &&
        request.auth.uid in get(/databases/$(database)/documents/clubs/$(clubId)).data.admins;
    }
    
    function isClubMember(clubId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/clubs/$(clubId)) &&
        (request.auth.uid in get(/databases/$(database)/documents/clubs/$(clubId)).data.members ||
         request.auth.uid in get(/databases/$(database)/documents/clubs/$(clubId)).data.admins);
    }
    
    function isTournamentOrganizer(tournamentId) {
      let tournament = get(/databases/$(database)/documents/tournaments/$(tournamentId)).data;
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/tournaments/$(tournamentId)) &&
        (request.auth.uid == tournament.createdByUserId ||
         request.auth.uid == tournament.organizerId);
    }
    
    function isLeagueAdmin(leagueId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/leagues/$(leagueId)) &&
        request.auth.uid == get(/databases/$(database)/documents/leagues/$(leagueId)).data.createdByUserId;
    }

    function isAppAdmin() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAppAdmin == true;
    }

    // ============================================
    // PLATFORM SETTINGS (Admin only)
    // ============================================
    
    match /platformSettings/{docId} {
      allow read: if isAuthenticated();
      // Write restricted to app admins (implement via Cloud Functions)
      allow write: if false;
    }
    
    // ============================================
    // WALLET COLLECTIONS
    // ============================================
    
    // Wallets - users can read their own, clubs can read member wallets
    match /wallets/{walletId} {
      allow read: if isAuthenticated() && (
        resource.data.odUserId == request.auth.uid ||
        isClubAdmin(resource.data.odClubId)
      );
      // All writes go through Cloud Functions for security
      allow write: if false;
    }
    
    // ============================================
    // TRANSACTION COLLECTIONS
    // ============================================
    
    // Transactions - users see their own, clubs see their transactions
    match /transactions/{transactionId} {
      allow read: if isAuthenticated() && (
        resource.data.odUserId == request.auth.uid ||
        (resource.data.odClubId != null && isClubAdmin(resource.data.odClubId)) ||
        (resource.data.tournamentId != null && isTournamentOrganizer(resource.data.tournamentId)) ||
        (resource.data.leagueId != null && isLeagueAdmin(resource.data.leagueId))
      );
      // All writes go through Cloud Functions
      allow write: if false;
    }
    
    // ============================================
    // PAYMENT COLLECTIONS
    // ============================================
    
    // Payments - similar access to transactions
    match /payments/{paymentId} {
      allow read: if isAuthenticated() && (
        resource.data.odUserId == request.auth.uid ||
        (resource.data.odClubId != null && isClubAdmin(resource.data.odClubId)) ||
        (resource.data.tournamentId != null && isTournamentOrganizer(resource.data.tournamentId)) ||
        (resource.data.leagueId != null && isLeagueAdmin(resource.data.leagueId))
      );
      allow write: if false;
    }
    
    // Refunds - users see their own, admins see club refunds
    match /refunds/{refundId} {
      allow read: if isAuthenticated() && (
        resource.data.odUserId == request.auth.uid ||
        (resource.data.odClubId != null && isClubAdmin(resource.data.odClubId))
      );
      // Users can request refunds (create), processing via Cloud Functions
      allow create: if isAuthenticated() && 
        request.resource.data.requestedByUserId == request.auth.uid;
      allow update, delete: if false;
    }
    
    // ============================================
    // ANNUAL PASSES
    // ============================================
    
    match /annualPasses/{passId} {
      allow read: if isAuthenticated() && (
        resource.data.odUserId == request.auth.uid ||
        isClubAdmin(resource.data.odClubId)
      );
      allow write: if false;
    }
    
    // ============================================
    // PAYOUT COLLECTIONS
    // ============================================
    
    match /payouts/{payoutId} {
      allow read: if isAuthenticated() && isClubAdmin(resource.data.odClubId);
      allow write: if false;
    }
    
    // ============================================
    // RECEIPT COLLECTIONS
    // ============================================
    
    match /receipts/{receiptId} {
      allow read: if isAuthenticated() && (
        resource.data.odUserId == request.auth.uid ||
        (resource.data.odClubId != null && isClubAdmin(resource.data.odClubId))
      );
      allow write: if false;
    }
    
    // ============================================
    // ACCOUNT COLLECTIONS
    // ============================================
    
    // User Accounts - users see their own financial summary
    match /userAccounts/{userId} {
      allow read: if isOwner(userId);
      allow write: if false;
    }
    
    // Club Accounts - club admins see club finances
    match /clubAccounts/{clubId} {
      allow read: if isAuthenticated() && isClubAdmin(clubId);
      allow write: if false;
    }
    
    // Tournament Accounts - organizers see tournament finances
    match /tournamentAccounts/{tournamentId} {
      allow read: if isAuthenticated() && isTournamentOrganizer(tournamentId);
      allow write: if false;
    }
    
    // League Accounts - league admins see league finances
    match /leagueAccounts/{leagueId} {
      allow read: if isAuthenticated() && isLeagueAdmin(leagueId);
      allow write: if false;
    }
    
    // ============================================
    // REPORT COLLECTIONS
    // ============================================
    
    match /reports/{reportId} {
      allow read: if isAuthenticated() && (
        resource.data.generatedByUserId == request.auth.uid ||
        (resource.data.odUserId != null && resource.data.odUserId == request.auth.uid) ||
        (resource.data.odClubId != null && isClubAdmin(resource.data.odClubId)) ||
        (resource.data.tournamentId != null && isTournamentOrganizer(resource.data.tournamentId)) ||
        (resource.data.leagueId != null && isLeagueAdmin(resource.data.leagueId))
      );
      allow write: if false;
    }
    
    match /scheduledReports/{scheduleId} {
      allow read: if isAuthenticated() && (
        resource.data.createdByUserId == request.auth.uid ||
        (resource.data.odClubId != null && isClubAdmin(resource.data.odClubId))
      );
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        resource.data.createdByUserId == request.auth.uid;
    }
    
    match /exportRequests/{exportId} {
      allow read: if isAuthenticated() && 
        resource.data.requestedByUserId == request.auth.uid;
      allow create: if isAuthenticated() && 
        request.resource.data.requestedByUserId == request.auth.uid;
      allow update, delete: if false;
    }
    
    // ============================================
    // AUDIT LOG COLLECTIONS
    // ============================================
    
    // Payment audit logs - strict access
    match /paymentAuditLogs/{logId} {
      // Only platform admins can read audit logs directly
      // Users access via reports/exports
      allow read: if false;
      allow write: if false;
    }
    
    // General audit logs (existing)
    match /audit_logs/{logId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // ============================================
    // CORE COLLECTIONS (SECURED)
    // ============================================

    // Users - SECURED: Users can only modify their own profile
    match /users/{userId} {
      // V07.12: Allow public read for viewing player profiles in standings/brackets
      allow read: if true;
      // Users can only write their own profile
      // IMPORTANT: Role changes (admin, organizer) should go through Cloud Functions
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) &&
        // Prevent users from self-promoting to admin
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['isAppAdmin', 'isRootAdmin']));
      allow delete: if false; // Users cannot delete profiles
    }

    // Meetups collection - SECURED
    // V07.12: Allow public read so users can browse meetups before signing in
    match /meetups/{meetupId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.createdByUserId == request.auth.uid;

      match /rsvps/{odUserId} {
        // V07.12: Allow public read for viewing meetup attendees
        allow read: if true;
        allow write: if isAuthenticated() && request.auth.uid == odUserId;
      }

      // Meetup matches subcollection (V06.16)
      match /matches/{matchId} {
        // V07.12: Allow public read for viewing meetup results
        allow read: if true;
        // Organizer can create/delete matches
        allow create, delete: if isAuthenticated() &&
          get(/databases/$(database)/documents/meetups/$(meetupId)).data.createdByUserId == request.auth.uid;
        // Organizer OR match participants can update (for score entry)
        allow update: if isAuthenticated() && (
          get(/databases/$(database)/documents/meetups/$(meetupId)).data.createdByUserId == request.auth.uid ||
          resource.data.player1Id == request.auth.uid ||
          resource.data.player2Id == request.auth.uid
        );
      }

      // Meetup standings subcollection (V06.16)
      match /standings/{odUserId} {
        // V07.12: Allow public read for viewing meetup standings
        allow read: if true;
        // Standings are updated automatically when matches complete
        allow write: if isAuthenticated();
      }
    }

    // Tournaments - SECURED: Only organizers or app admins can modify
    // V07.12: Allow public read so users can browse tournaments before signing in
    match /tournaments/{tournamentId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isTournamentOrganizer(tournamentId) || isAppAdmin();

      match /divisions/{divisionId} {
        // V07.12: Allow public read for browsing tournament brackets
        allow read: if true;
        // V07.08: Allow organizer, app admin, or tournament staff to write divisions
        allow write: if isTournamentOrganizer(tournamentId) ||
          isAppAdmin() ||
          (isAuthenticated() &&
           request.auth.uid in get(/databases/$(database)/documents/tournaments/$(tournamentId)).data.staffIds);

        // V06.33 Results Table Architecture - Pool Results subcollection
        // V07.29: Added isAppAdmin() and staff access for consistency with divisions
        match /poolResults/{poolKey} {
          allow read: if isAuthenticated();
          allow write: if isTournamentOrganizer(tournamentId) ||
            isAppAdmin() ||
            (isAuthenticated() &&
             request.auth.uid in get(/databases/$(database)/documents/tournaments/$(tournamentId)).data.staffIds);
        }

        // V06.33 Results Table Architecture - Bracket Seeds subcollection
        // V07.29: Added isAppAdmin() and staff access for consistency with divisions
        match /bracketSeeds/{bracketType} {
          allow read: if isAuthenticated();
          allow write: if isTournamentOrganizer(tournamentId) ||
            isAppAdmin() ||
            (isAuthenticated() &&
             request.auth.uid in get(/databases/$(database)/documents/tournaments/$(tournamentId)).data.staffIds);
        }
      }
      match /teams/{teamId} {
        // V07.12: Allow public read for viewing tournament brackets
        allow read: if true;
        // Teams can be created by authenticated users (registration)
        allow create: if isAuthenticated();
        // Only organizers, team members, or app admin can update
        allow update: if isTournamentOrganizer(tournamentId) ||
          (isAuthenticated() && request.auth.uid in resource.data.playerIds) ||
          isAppAdmin();
        // Organizer or app admin can delete teams
        allow delete: if isTournamentOrganizer(tournamentId) || isAppAdmin();
      }
      match /matches/{matchId} {
        // V07.12: Allow public read for viewing tournament brackets
        allow read: if true;
        // Tournament organizer or app admin can write any match field
        allow create, delete: if isTournamentOrganizer(tournamentId) || isAppAdmin();
        // Update rules depend on what's being changed
        allow update: if isTournamentOrganizer(tournamentId) || isAppAdmin() ||
          // Players can update scoreProposal if:
          // 1. Score is not locked by organizer
          // 2. They are a participant in the match
          // 3. They are NOT writing to restricted fields
          (isAuthenticated() &&
           resource.data.scoreLocked != true &&
           (request.auth.uid in resource.data.sideA.playerIds ||
            request.auth.uid in resource.data.sideB.playerIds) &&
           !request.resource.data.diff(resource.data).affectedKeys().hasAny(['officialResult', 'dupr', 'scoreLocked', 'scoreLockedAt', 'scoreLockedByUserId', 'migratedAt', 'migratedFromLegacy']));
      }
      match /courts/{courtId} {
        allow read: if isAuthenticated();
        allow write: if isTournamentOrganizer(tournamentId);
      }
      match /scoreSubmissions/{subId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isTournamentOrganizer(tournamentId);
      }

      // Tournament Communications Queue - V07.08
      // Messages queue for SMS/Email notifications to players
      match /comms_queue/{messageId} {
        // Only tournament organizers can read the queue
        allow read: if isTournamentOrganizer(tournamentId);
        // Organizers can create pending messages (must match tournament)
        allow create: if isTournamentOrganizer(tournamentId) &&
          request.resource.data.status == 'pending' &&
          request.resource.data.tournamentId == tournamentId;
        // Status updates only via Cloud Functions (lockedAt, sentAt, failedAt, etc.)
        allow update: if false;
        // Organizers can delete pending or failed messages
        allow delete: if isTournamentOrganizer(tournamentId) &&
          (resource.data.status == 'pending' || resource.data.status == 'failed');
      }
    }

    // Clubs - SECURED: Only admins can modify club settings
    // V07.12: Allow public read so users can browse clubs before signing in
    match /clubs/{clubId} {
      allow read: if true;
      allow create: if isAuthenticated();
      // Club admins, creator, owner, or app admins can update/delete the club
      allow update: if isClubAdmin(clubId) ||
        (isAuthenticated() && resource.data.createdByUserId == request.auth.uid) ||
        (isAuthenticated() && resource.data.ownerId == request.auth.uid) ||
        isAppAdmin();
      allow delete: if isAuthenticated() && (
        resource.data.createdByUserId == request.auth.uid ||
        resource.data.ownerId == request.auth.uid
      ) || isAppAdmin();

      match /joinRequests/{requestId} {
        allow read: if isAuthenticated();
        // Users can create their own join requests
        allow create: if isAuthenticated();
        // Only club admins can approve/deny requests
        allow update, delete: if isClubAdmin(clubId);
      }
      match /courts/{courtId} {
        allow read: if isAuthenticated();
        allow write: if isClubAdmin(clubId);
      }
      match /bookings/{bookingId} {
        allow read: if isAuthenticated();
        // Members can create bookings
        allow create: if isClubMember(clubId);
        // Users can update/cancel their own bookings, admins can manage all
        allow update, delete: if isClubAdmin(clubId) ||
          (isAuthenticated() && resource.data.bookedByUserId == request.auth.uid);
      }

      // Club branding settings
      match /branding/{brandingId} {
        allow read: if isAuthenticated();
        allow write: if isClubAdmin(clubId);
      }

      // Club payout settings
      match /payoutSettings/{settingsId} {
        allow read: if isClubAdmin(clubId);
        allow write: if isClubAdmin(clubId);
      }
    }

    // Leagues - SECURED: Only league admins can modify
    // V07.12: Allow public read so users can browse leagues before signing in
    match /leagues/{leagueId} {
      allow read: if true;
      allow create: if isAuthenticated();
      // V07.12: Allow authenticated users to update memberCount when joining
      // Full update/delete still requires league admin
      allow update: if isLeagueAdmin(leagueId) ||
        (isAuthenticated() &&
         // Only allow memberCount and updatedAt to be modified by non-admins (for joining)
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberCount', 'updatedAt']));
      allow delete: if isLeagueAdmin(leagueId);

      match /members/{memberId} {
        // V07.12: Allow public read for viewing league standings
        allow read: if true;
        // Users can join leagues (create their membership)
        allow create: if isAuthenticated();
        // V07.28: Update rules for direct join flow
        allow update: if isLeagueAdmin(leagueId) ||
          isAppAdmin() ||
          // Member owner (primary) can update their own record
          (isAuthenticated() && resource.data.userId == request.auth.uid) ||
          // Partner can also update (e.g., to leave the team)
          (isAuthenticated() && resource.data.get('partnerUserId', '') == request.auth.uid) ||
          // V07.28: Allow joining open teams - if team is looking for partner, anyone can join
          (isAuthenticated() && resource.data.get('isLookingForPartner', false) == true) ||
          // Allow any league member to update stats (for score submission)
          (isAuthenticated() &&
           exists(/databases/$(database)/documents/leagues/$(leagueId)/members/$(request.auth.uid)));
        allow delete: if isLeagueAdmin(leagueId);
      }
      match /matches/{matchId} {
        // V07.12: Allow public read for viewing league match results
        allow read: if true;
        // League admin can do anything
        allow create, delete: if isLeagueAdmin(leagueId);
        // League admin OR match participants can update (for score entry)
        // V07.10: Players cannot write to restricted DUPR fields or when scoreLocked
        // V07.39: Players cannot modify structural fields (sideA, sideB, weekNumber, boxNumber, eventId)
        // Use get() with default to safely check fields that may not exist
        allow update: if isLeagueAdmin(leagueId) ||
          (isAuthenticated() &&
           resource.data.get('scoreLocked', false) != true &&
           (resource.data.get('userAId', '') == request.auth.uid ||
            resource.data.get('userBId', '') == request.auth.uid ||
            resource.data.get('partnerAId', '') == request.auth.uid ||
            resource.data.get('partnerBId', '') == request.auth.uid ||
            (request.auth.uid in resource.data.get('sideA', {}).get('playerIds', [])) ||
            (request.auth.uid in resource.data.get('sideB', {}).get('playerIds', []))) &&
           !request.resource.data.diff(resource.data).affectedKeys().hasAny([
             'officialResult', 'dupr', 'scoreLocked', 'scoreLockedAt', 'scoreLockedByUserId',
             'migratedAt', 'migratedFromLegacy',
             'sideA', 'sideB', 'weekNumber', 'boxNumber', 'eventId', 'eventType', 'format',
             'roundNumber', 'matchNumberInBox', 'createdAt', 'rotationVersion', 'idempotencyKey'
           ]));
      }
      match /challenges/{challengeId} {
        allow read: if isAuthenticated();
        // Users can create challenges
        allow create: if isAuthenticated();
        // Participants or admins can update
        allow update: if isLeagueAdmin(leagueId) ||
          (isAuthenticated() && (
            resource.data.challengerId == request.auth.uid ||
            resource.data.challengedId == request.auth.uid
          ));
        allow delete: if isLeagueAdmin(leagueId);
      }
      // V07.14: League standings subcollection (same pattern as tournament poolResults)
      // Standings are derived snapshots - matches are truth
      match /standings/{standingsKey} {
        // Anyone can read standings (public data)
        allow read: if true;
        // Only league admin or app admin can write (auto-updated by app)
        allow write: if isLeagueAdmin(leagueId) || isAppAdmin();
      }
      // V07.17: League Communications Queue
      // Messages queue for SMS/Email notifications to league players
      match /comms_queue/{messageId} {
        // Only league organizer can read the queue
        allow read: if isLeagueAdmin(leagueId);
        // League organizer can create pending messages only
        allow create: if isLeagueAdmin(leagueId) &&
          request.resource.data.status == 'pending' &&
          request.resource.data.leagueId == leagueId &&
          request.resource.data.createdBy == request.auth.uid;
        // Status updates only via Cloud Functions (no client updates)
        allow update: if false;
        // League organizer can delete pending or failed messages
        allow delete: if isLeagueAdmin(leagueId) &&
          (resource.data.status == 'pending' || resource.data.status == 'failed');
      }

      // V07.25: Box League Weeks - Weekly state for rotating doubles box leagues
      // Stores box assignments, attendance, match IDs, and standings snapshots
      match /boxWeeks/{weekNumber} {
        // Anyone can read weekly assignments/standings (like standings)
        allow read: if true;
        // Only league admin can create/update/delete weeks
        allow create, update, delete: if isLeagueAdmin(leagueId);
      }

      // V07.25: Box League Seasons - Season configuration for box leagues
      // Stores season dates, week schedule, rules snapshot
      match /boxSeasons/{seasonId} {
        // Anyone can read season info (like league info)
        allow read: if true;
        // Only league admin can manage seasons
        allow create, update, delete: if isLeagueAdmin(leagueId);

        // Season player stats subcollection
        match /playerStats/{odUserId} {
          // Anyone can read stats (leaderboard is public)
          allow read: if true;
          // Only league admin can update stats
          allow write: if isLeagueAdmin(leagueId);
        }
      }

      // V07.25: Box Players - Legacy box league player management
      // Note: rotating_doubles_box uses members subcollection instead
      match /boxPlayers/{playerId} {
        // Anyone can read box players (like standings)
        allow read: if true;
        // Only league admin can manage box players
        allow create, update, delete: if isLeagueAdmin(leagueId);
      }
    }

    // Tournament Registrations - SECURED
    match /tournament_registrations/{regId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Only the registrant or tournament organizer can update/cancel
      // Note: registrations use playerId field, not odUserId
      allow update, delete: if isAuthenticated() &&
        (resource.data.playerId == request.auth.uid ||
         isTournamentOrganizer(resource.data.tournamentId));
    }

    // Partner Invites - SECURED (for tournaments)
    // Note: Data uses inviterId (sender) and invitedUserId (recipient) field names
    match /partnerInvites/{inviteId} {
      allow read: if isAuthenticated() && (
        resource.data.inviterId == request.auth.uid ||
        resource.data.invitedUserId == request.auth.uid
      );
      allow create: if isAuthenticated();
      // Only sender or recipient can update (accept/decline)
      allow update: if isAuthenticated() && (
        resource.data.inviterId == request.auth.uid ||
        resource.data.invitedUserId == request.auth.uid
      );
      allow delete: if isAuthenticated() && resource.data.inviterId == request.auth.uid;
    }

    // V07.27: League Partner Invites - SECURED (for doubles leagues)
    // Note: Data uses inviterId (sender) and invitedUserId (recipient) field names
    match /leaguePartnerInvites/{inviteId} {
      allow read: if isAuthenticated() && (
        resource.data.inviterId == request.auth.uid ||
        resource.data.invitedUserId == request.auth.uid
      );
      // Users can create invites for themselves (inviterId must match)
      allow create: if isAuthenticated() &&
        request.resource.data.inviterId == request.auth.uid;
      // Only sender or recipient can update (accept/decline)
      allow update: if isAuthenticated() && (
        resource.data.inviterId == request.auth.uid ||
        resource.data.invitedUserId == request.auth.uid
      );
      // Sender can delete their own invites
      allow delete: if isAuthenticated() && resource.data.inviterId == request.auth.uid;
    }

    // V07.27: League Join Requests - DEPRECATED (V07.28)
    // This collection is no longer actively used since open teams now auto-accept partners.
    // Rules kept for cleanup of legacy data only.
    match /leagueJoinRequests/{requestId} {
      allow read: if isAuthenticated() && (
        resource.data.requesterId == request.auth.uid ||
        resource.data.openTeamOwnerUserId == request.auth.uid
      );
      // No new requests should be created - direct join flow is now used
      allow create: if false;
      // Allow status updates for cleanup - any authenticated user can cancel pending requests
      // This is safe since the collection is deprecated and requests expire naturally
      allow update: if isAuthenticated();
      // Allow deletion for cleanup
      allow delete: if isAuthenticated();
    }

    // Social Events - SECURED
    match /social_events/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.createdByUserId == request.auth.uid;
    }

    // Audit logs - only create allowed
    match /team_creation_audit/{auditId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // Teams (root level) - SECURED
    match /teams/{teamId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Only team members or related organizers can update
      allow update: if isAuthenticated() && (
        request.auth.uid in resource.data.playerIds ||
        isTournamentOrganizer(resource.data.tournamentId)
      );
      allow delete: if isTournamentOrganizer(resource.data.tournamentId);
    }

    // Competitions - SECURED
    match /competitions/{competitionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.createdByUserId == request.auth.uid;

      match /entries/{entryId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAuthenticated() && (
          resource.data.odUserId == request.auth.uid ||
          get(/databases/$(database)/documents/competitions/$(competitionId)).data.createdByUserId == request.auth.uid
        );
      }
      match /matches/{matchId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() &&
          get(/databases/$(database)/documents/competitions/$(competitionId)).data.createdByUserId == request.auth.uid;
      }
    }

    match /competitionEntries/{entryId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.odUserId == request.auth.uid;
    }

    // Standings - read only for users, write via Cloud Functions
    match /standings/{standingId} {
      allow read: if isAuthenticated();
      allow write: if false; // Updated by Cloud Functions only
    }

    // Match Score Submissions - SECURED
    match /matchScoreSubmissions/{submissionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Only the submitter can update their submission
      allow update: if isAuthenticated() && resource.data.submittedByUserId == request.auth.uid;
      allow delete: if false;
    }

    // Organizer Requests - SECURED
    match /organizerRequests/{requestId} {
      allow read: if isAuthenticated() && resource.data.odUserId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.odUserId == request.auth.uid;
      allow update, delete: if false; // Admin actions via Cloud Functions
    }

    // ============================================
    // LIVE SCORING COLLECTIONS (NEW V06.03)
    // ============================================

    // Live Scores - Real-time match scoring for events
    match /liveScores/{scoreId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Owner, scorer, or event organizer can update
      allow update: if isAuthenticated() && (
        resource.data.scorerId == request.auth.uid ||
        (resource.data.teamA.playerIds != null && request.auth.uid in resource.data.teamA.playerIds) ||
        (resource.data.teamB.playerIds != null && request.auth.uid in resource.data.teamB.playerIds)
      );
      allow delete: if isAuthenticated() && resource.data.scorerId == request.auth.uid;
    }

    // Standalone Games - Personal game scoring not tied to events
    match /standaloneGames/{gameId} {
      allow read: if isAuthenticated();
      // Owner can create and manage their games
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
    }

    // Scoreboard Configs - Event scoreboard display settings
    match /scoreboardConfigs/{configId} {
      allow read: if isAuthenticated();
      // Event organizers can manage scoreboard configs
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // ============================================
    // SMS & NOTIFICATIONS (V06.21)
    // ============================================

    // SMS Messages - Queue for Twilio sending
    match /sms_messages/{messageId} {
      allow read: if isAuthenticated();
      // Organizers, admins, and authenticated users can create SMS notifications
      allow create: if isAuthenticated();
      // Only system can update (via Cloud Functions)
      allow update, delete: if false;
    }

    // Phone Verification Codes - Access via Cloud Functions only
    match /phone_verification_codes/{codeId} {
      // No direct client access - all via Cloud Functions
      allow read, write: if false;
    }

    // ============================================
    // COMMUNICATIONS (V07.08)
    // ============================================

    // Message Templates - Global templates for tournaments/leagues
    match /comms_templates/{templateId} {
      // All authenticated users can read templates
      allow read: if isAuthenticated();
      // Only app admins can create/update/delete templates
      allow write: if isAppAdmin();
    }

    // ============================================
    // SMS CREDITS (V07.19)
    // ============================================

    // SMS Credits - Organizer SMS balance and usage tracking
    match /sms_credits/{userId} {
      // Users can read their own credits
      allow read: if isOwner(userId);
      // Only Cloud Functions can write credits (for security)
      allow write: if false;

      // Usage logs - read only for owner
      match /usage/{usageId} {
        allow read: if isOwner(userId);
        allow write: if false;
      }

      // Purchase history - read only for owner
      match /purchases/{purchaseId} {
        allow read: if isOwner(userId);
        allow write: if false;
      }
    }

    // SMS Bundles - Available bundles for purchase
    match /sms_bundles/{bundleId} {
      // Anyone authenticated can read active bundles
      allow read: if isAuthenticated();
      // Only app admins can manage bundles
      allow write: if isAppAdmin();
    }

    // ============================================
    // ORGANIZER REQUESTS (V07.23)
    // ============================================

    // Organizer access requests - users apply, admins approve/deny
    match /organizer_requests/{requestId} {
      // Users can read their own request, admins can read all
      allow read: if isAuthenticated() && (
        requestId == request.auth.uid ||
        isAppAdmin()
      );
      // Users can create a request for themselves
      allow create: if isAuthenticated() &&
        requestId == request.auth.uid &&
        request.resource.data.odUserId == request.auth.uid;
      // Only admins can update (approve/deny) or delete
      allow update, delete: if isAppAdmin();
    }

    // ============================================
    // DUPR SUBMISSION COLLECTIONS (V07.04)
    // ============================================

    // DUPR Submission Batches - Organizers can read their batches
    match /dupr_submission_batches/{batchId} {
      allow read: if isAuthenticated() && (
        resource.data.createdByUserId == request.auth.uid ||
        (resource.data.eventType == 'tournament' && isTournamentOrganizer(resource.data.eventId)) ||
        (resource.data.eventType == 'league' && isLeagueAdmin(resource.data.eventId))
      );
      // All writes go through Cloud Functions
      allow write: if false;
    }

    // ============================================
    // PRIVACY & SECURITY COLLECTIONS (V06.04)
    // ============================================

    // Security Breaches - Admin only
    match /security_breaches/{breachId} {
      allow read: if isAppAdmin();
      allow create: if isAppAdmin();
      allow update: if isAppAdmin();
      allow delete: if false; // Never delete breach records
    }

    // Privacy Requests - Admin can read/write, users can create and read their own
    match /privacy_requests/{requestId} {
      // Admins can read all, users can read their own
      allow read: if isAppAdmin() ||
        (isAuthenticated() && resource.data.userId == request.auth.uid);
      // Anyone can create a privacy request
      allow create: if true;
      // Only admins can update
      allow update: if isAppAdmin();
      allow delete: if false; // Keep records for compliance
    }

    // Data Retention Logs - Admin only
    match /data_retention_logs/{logId} {
      allow read: if isAppAdmin();
      allow write: if false; // Only Cloud Functions write these
    }

    // Retention Policies - Admin only
    match /retention_policies/{policyId} {
      allow read: if isAppAdmin();
      allow write: if isAppAdmin();
    }
  }
}
