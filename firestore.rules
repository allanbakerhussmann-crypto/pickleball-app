rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isClubAdmin(clubId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/clubs/$(clubId)) &&
        request.auth.uid in get(/databases/$(database)/documents/clubs/$(clubId)).data.admins;
    }

    // Check if user is club owner OR admin (for standing meetups, etc.)
    function isClubOwnerOrAdmin(clubId) {
      let club = get(/databases/$(database)/documents/clubs/$(clubId)).data;
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/clubs/$(clubId)) &&
        (request.auth.uid == club.ownerId ||
         request.auth.uid in club.admins ||
         request.auth.uid == club.createdByUserId);
    }

    function isClubMember(clubId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/clubs/$(clubId)) &&
        (request.auth.uid in get(/databases/$(database)/documents/clubs/$(clubId)).data.members ||
         request.auth.uid in get(/databases/$(database)/documents/clubs/$(clubId)).data.admins);
    }
    
    function isTournamentOrganizer(tournamentId) {
      let tournament = get(/databases/$(database)/documents/tournaments/$(tournamentId)).data;
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/tournaments/$(tournamentId)) &&
        (request.auth.uid == tournament.createdByUserId ||
         request.auth.uid == tournament.organizerId);
    }
    
    function isLeagueAdmin(leagueId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/leagues/$(leagueId)) &&
        request.auth.uid == get(/databases/$(database)/documents/leagues/$(leagueId)).data.createdByUserId;
    }

    // V07.57: Team League Admin Helper
    // Check if user is the organizer of a team league or app admin
    function isTeamLeagueAdmin(teamLeagueId) {
      return isAppAdmin() ||
        (isAuthenticated() &&
         exists(/databases/$(database)/documents/teamLeagues/$(teamLeagueId)) &&
         request.auth.uid == get(/databases/$(database)/documents/teamLeagues/$(teamLeagueId)).data.createdByUserId);
    }

    // V07.57: Check if user is a captain in the fixture (uses denormalized captain IDs)
    function isTeamCaptainInFixture(fixtureData) {
      return request.auth.uid == fixtureData.homeCaptainId ||
             request.auth.uid == fixtureData.awayCaptainId;
    }

    function isAppAdmin() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAppAdmin == true;
    }

    // ============================================
    // PLATFORM SETTINGS (Admin only)
    // ============================================
    
    match /platformSettings/{docId} {
      allow read: if isAuthenticated();
      // Write restricted to app admins (implement via Cloud Functions)
      allow write: if false;
    }
    
    // ============================================
    // WALLET COLLECTIONS
    // ============================================
    
    // Wallets - users can read their own, clubs can read member wallets
    match /wallets/{walletId} {
      allow read: if isAuthenticated() && (
        resource.data.odUserId == request.auth.uid ||
        isClubAdmin(resource.data.odClubId)
      );
      // All writes go through Cloud Functions for security
      allow write: if false;
    }
    
    // ============================================
    // TRANSACTION COLLECTIONS
    // ============================================
    
    // Transactions - users see their own, clubs see their transactions, app admins see all
    match /transactions/{transactionId} {
      allow read: if isAuthenticated() && (
        // App admins can read ALL transactions for Platform Finance dashboard
        isAppAdmin() ||
        // Users can see their own transactions
        resource.data.odUserId == request.auth.uid ||
        // Club admins can see club transactions
        (resource.data.odClubId != null && isClubAdmin(resource.data.odClubId)) ||
        // Tournament organizers can see tournament transactions
        (resource.data.tournamentId != null && isTournamentOrganizer(resource.data.tournamentId)) ||
        // League admins can see league transactions
        (resource.data.leagueId != null && isLeagueAdmin(resource.data.leagueId)) ||
        // Organizers can see their own organizer transactions (meetups, leagues organized by individuals)
        (resource.data.organizerUserId != null && resource.data.organizerUserId == request.auth.uid)
      );
      // All writes go through Cloud Functions
      allow write: if false;
    }
    
    // ============================================
    // PAYMENT COLLECTIONS
    // ============================================
    
    // Payments - similar access to transactions
    match /payments/{paymentId} {
      allow read: if isAuthenticated() && (
        resource.data.odUserId == request.auth.uid ||
        (resource.data.odClubId != null && isClubAdmin(resource.data.odClubId)) ||
        (resource.data.tournamentId != null && isTournamentOrganizer(resource.data.tournamentId)) ||
        (resource.data.leagueId != null && isLeagueAdmin(resource.data.leagueId))
      );
      allow write: if false;
    }
    
    // Refunds - users see their own, admins see club refunds
    match /refunds/{refundId} {
      allow read: if isAuthenticated() && (
        resource.data.odUserId == request.auth.uid ||
        (resource.data.odClubId != null && isClubAdmin(resource.data.odClubId))
      );
      // Users can request refunds (create), processing via Cloud Functions
      allow create: if isAuthenticated() && 
        request.resource.data.requestedByUserId == request.auth.uid;
      allow update, delete: if false;
    }
    
    // ============================================
    // ANNUAL PASSES
    // ============================================
    
    match /annualPasses/{passId} {
      allow read: if isAuthenticated() && (
        resource.data.odUserId == request.auth.uid ||
        isClubAdmin(resource.data.odClubId)
      );
      allow write: if false;
    }
    
    // ============================================
    // PAYOUT COLLECTIONS
    // ============================================
    
    match /payouts/{payoutId} {
      allow read: if isAuthenticated() && isClubAdmin(resource.data.odClubId);
      allow write: if false;
    }
    
    // ============================================
    // RECEIPT COLLECTIONS
    // ============================================
    
    match /receipts/{receiptId} {
      allow read: if isAuthenticated() && (
        resource.data.odUserId == request.auth.uid ||
        (resource.data.odClubId != null && isClubAdmin(resource.data.odClubId))
      );
      allow write: if false;
    }
    
    // ============================================
    // ACCOUNT COLLECTIONS
    // ============================================
    
    // User Accounts - users see their own financial summary
    match /userAccounts/{userId} {
      allow read: if isOwner(userId);
      allow write: if false;
    }
    
    // Club Accounts - club admins see club finances
    match /clubAccounts/{clubId} {
      allow read: if isAuthenticated() && isClubAdmin(clubId);
      allow write: if false;
    }
    
    // Tournament Accounts - organizers see tournament finances
    match /tournamentAccounts/{tournamentId} {
      allow read: if isAuthenticated() && isTournamentOrganizer(tournamentId);
      allow write: if false;
    }
    
    // League Accounts - league admins see league finances
    match /leagueAccounts/{leagueId} {
      allow read: if isAuthenticated() && isLeagueAdmin(leagueId);
      allow write: if false;
    }
    
    // ============================================
    // REPORT COLLECTIONS
    // ============================================
    
    match /reports/{reportId} {
      allow read: if isAuthenticated() && (
        resource.data.generatedByUserId == request.auth.uid ||
        (resource.data.odUserId != null && resource.data.odUserId == request.auth.uid) ||
        (resource.data.odClubId != null && isClubAdmin(resource.data.odClubId)) ||
        (resource.data.tournamentId != null && isTournamentOrganizer(resource.data.tournamentId)) ||
        (resource.data.leagueId != null && isLeagueAdmin(resource.data.leagueId))
      );
      allow write: if false;
    }
    
    match /scheduledReports/{scheduleId} {
      allow read: if isAuthenticated() && (
        resource.data.createdByUserId == request.auth.uid ||
        (resource.data.odClubId != null && isClubAdmin(resource.data.odClubId))
      );
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        resource.data.createdByUserId == request.auth.uid;
    }
    
    match /exportRequests/{exportId} {
      allow read: if isAuthenticated() && 
        resource.data.requestedByUserId == request.auth.uid;
      allow create: if isAuthenticated() && 
        request.resource.data.requestedByUserId == request.auth.uid;
      allow update, delete: if false;
    }
    
    // ============================================
    // AUDIT LOG COLLECTIONS
    // ============================================
    
    // Payment audit logs - strict access
    match /paymentAuditLogs/{logId} {
      // Only platform admins can read audit logs directly
      // Users access via reports/exports
      allow read: if false;
      allow write: if false;
    }
    
    // General audit logs (existing)
    match /audit_logs/{logId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // ============================================
    // CORE COLLECTIONS (SECURED)
    // ============================================

    // Users - SECURED: Users can only modify their own profile
    match /users/{userId} {
      // V07.12: Allow public read for viewing player profiles in standings/brackets
      allow read: if true;
      // Users can only write their own profile
      // IMPORTANT: Role changes (admin, organizer) should go through Cloud Functions
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) &&
        // Prevent users from self-promoting to admin
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['isAppAdmin', 'isRootAdmin']));
      allow delete: if false; // Users cannot delete profiles
    }

    // Meetups collection - SECURED
    // V07.12: Allow public read so users can browse meetups before signing in
    match /meetups/{meetupId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.createdByUserId == request.auth.uid;

      match /rsvps/{odUserId} {
        // V07.12: Allow public read for viewing meetup attendees
        allow read: if true;
        allow write: if isAuthenticated() && request.auth.uid == odUserId;
      }

      // Meetup matches subcollection (V06.16)
      match /matches/{matchId} {
        // V07.12: Allow public read for viewing meetup results
        allow read: if true;
        // Organizer can create/delete matches
        allow create, delete: if isAuthenticated() &&
          get(/databases/$(database)/documents/meetups/$(meetupId)).data.createdByUserId == request.auth.uid;
        // Organizer OR match participants can update (for score entry)
        allow update: if isAuthenticated() && (
          get(/databases/$(database)/documents/meetups/$(meetupId)).data.createdByUserId == request.auth.uid ||
          resource.data.player1Id == request.auth.uid ||
          resource.data.player2Id == request.auth.uid
        );
      }

      // Meetup standings subcollection (V06.16)
      match /standings/{odUserId} {
        // V07.12: Allow public read for viewing meetup standings
        allow read: if true;
        // Standings are updated automatically when matches complete
        allow write: if isAuthenticated();
      }
    }

    // Tournaments - SECURED: Only organizers or app admins can modify
    // V07.12: Allow public read so users can browse tournaments before signing in
    match /tournaments/{tournamentId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isTournamentOrganizer(tournamentId) || isAppAdmin();

      match /divisions/{divisionId} {
        // V07.12: Allow public read for browsing tournament brackets
        allow read: if true;
        // V07.08: Allow organizer, app admin, or tournament staff to write divisions
        allow write: if isTournamentOrganizer(tournamentId) ||
          isAppAdmin() ||
          (isAuthenticated() &&
           request.auth.uid in get(/databases/$(database)/documents/tournaments/$(tournamentId)).data.staffIds);

        // V06.33 Results Table Architecture - Pool Results subcollection
        // V07.29: Added isAppAdmin() and staff access for consistency with divisions
        match /poolResults/{poolKey} {
          allow read: if isAuthenticated();
          allow write: if isTournamentOrganizer(tournamentId) ||
            isAppAdmin() ||
            (isAuthenticated() &&
             request.auth.uid in get(/databases/$(database)/documents/tournaments/$(tournamentId)).data.staffIds);
        }

        // V06.33 Results Table Architecture - Bracket Seeds subcollection
        // V07.29: Added isAppAdmin() and staff access for consistency with divisions
        match /bracketSeeds/{bracketType} {
          allow read: if isAuthenticated();
          allow write: if isTournamentOrganizer(tournamentId) ||
            isAppAdmin() ||
            (isAuthenticated() &&
             request.auth.uid in get(/databases/$(database)/documents/tournaments/$(tournamentId)).data.staffIds);
        }
      }
      match /teams/{teamId} {
        // V07.12: Allow public read for viewing tournament brackets
        allow read: if true;
        // Teams can be created by authenticated users (registration)
        allow create: if isAuthenticated();
        // Only organizers, team members, or app admin can update
        allow update: if isTournamentOrganizer(tournamentId) ||
          (isAuthenticated() && request.auth.uid in resource.data.playerIds) ||
          isAppAdmin();
        // Organizer or app admin can delete teams
        allow delete: if isTournamentOrganizer(tournamentId) || isAppAdmin();
      }
      match /matches/{matchId} {
        // V07.12: Allow public read for viewing tournament brackets
        allow read: if true;
        // Tournament organizer or app admin can write any match field
        allow create, delete: if isTournamentOrganizer(tournamentId) || isAppAdmin();
        // V07.52: Allow any authenticated user to update matches (simplified for testing)
        // Protected fields still require organizer/admin
        allow update: if isTournamentOrganizer(tournamentId) || isAppAdmin() ||
          (isAuthenticated() &&
           !request.resource.data.diff(resource.data).affectedKeys().hasAny(['officialResult', 'dupr', 'scoreLocked', 'scoreLockedAt', 'scoreLockedByUserId', 'migratedAt', 'migratedFromLegacy']));
      }
      match /courts/{courtId} {
        allow read: if isAuthenticated();
        allow write: if isTournamentOrganizer(tournamentId);
      }

      // V07.51: Division Stats - Capacity tracking for entry limits
      // Used by reserveDivisionCapacity/releaseDivisionCapacity for transactional counters
      match /divisionStats/{divisionId} {
        // Anyone can read to check capacity before registration
        allow read: if isAuthenticated();
        // Authenticated users can write (transactional updates during registration)
        allow write: if isAuthenticated();
      }
      match /scoreSubmissions/{subId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isTournamentOrganizer(tournamentId);
      }

      // Tournament Communications Queue - V07.08
      // Messages queue for SMS/Email notifications to players
      match /comms_queue/{messageId} {
        // Only tournament organizers can read the queue
        allow read: if isTournamentOrganizer(tournamentId);
        // Organizers can create pending messages (must match tournament)
        allow create: if isTournamentOrganizer(tournamentId) &&
          request.resource.data.status == 'pending' &&
          request.resource.data.tournamentId == tournamentId;
        // Status updates only via Cloud Functions (lockedAt, sentAt, failedAt, etc.)
        allow update: if false;
        // Organizers can delete pending or failed messages
        allow delete: if isTournamentOrganizer(tournamentId) &&
          (resource.data.status == 'pending' || resource.data.status == 'failed');
      }
    }

    // Clubs - SECURED: Only admins can modify club settings
    // V07.12: Allow public read so users can browse clubs before signing in
    match /clubs/{clubId} {
      allow read: if true;
      allow create: if isAuthenticated();
      // Club admins, creator, owner, or app admins can update/delete the club
      allow update: if isClubAdmin(clubId) ||
        (isAuthenticated() && resource.data.createdByUserId == request.auth.uid) ||
        (isAuthenticated() && resource.data.ownerId == request.auth.uid) ||
        isAppAdmin();
      allow delete: if isAuthenticated() && (
        resource.data.createdByUserId == request.auth.uid ||
        resource.data.ownerId == request.auth.uid
      ) || isAppAdmin();

      match /joinRequests/{requestId} {
        allow read: if isAuthenticated();
        // Users can create their own join requests
        allow create: if isAuthenticated();
        // Only club admins can approve/deny requests
        allow update, delete: if isClubAdmin(clubId);
      }
      match /courts/{courtId} {
        allow read: if isAuthenticated();
        allow write: if isClubAdmin(clubId);
      }
      match /bookings/{bookingId} {
        allow read: if isAuthenticated();
        // Members can create bookings
        allow create: if isClubMember(clubId);
        // Users can update/cancel their own bookings, admins can manage all
        allow update, delete: if isClubAdmin(clubId) ||
          (isAuthenticated() && resource.data.bookedByUserId == request.auth.uid);
      }

      // Club branding settings
      match /branding/{brandingId} {
        allow read: if isAuthenticated();
        allow write: if isClubAdmin(clubId);
      }

      // Club payout settings
      match /payoutSettings/{settingsId} {
        allow read: if isClubAdmin(clubId);
        allow write: if isClubAdmin(clubId);
      }
    }

    // Leagues - SECURED: Only league admins can modify
    // V07.12: Allow public read so users can browse leagues before signing in
    match /leagues/{leagueId} {
      allow read: if true;
      allow create: if isAuthenticated();
      // V07.12: Allow authenticated users to update memberCount when joining
      // Full update/delete still requires league admin
      allow update: if isLeagueAdmin(leagueId) || isAppAdmin() ||
        (isAuthenticated() &&
         // Only allow memberCount and updatedAt to be modified by non-admins (for joining)
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberCount', 'updatedAt']));
      // V07.55: Allow league admin or app admin to delete
      allow delete: if isLeagueAdmin(leagueId) || isAppAdmin();

      match /members/{memberId} {
        // V07.12: Allow public read for viewing league standings
        allow read: if true;
        // V07.50: BLOCKED - must go through league_join Cloud Function
        // This prevents bypassing DUPR+ gate enforcement
        allow create: if false;
        // V07.28: Update rules for direct join flow
        allow update: if isLeagueAdmin(leagueId) ||
          isAppAdmin() ||
          // Member owner (primary) can update their own record
          (isAuthenticated() && resource.data.userId == request.auth.uid) ||
          // Partner can also update (e.g., to leave the team)
          (isAuthenticated() && resource.data.get('partnerUserId', '') == request.auth.uid) ||
          // V07.28: Allow joining open teams - if team is looking for partner, anyone can join
          (isAuthenticated() && resource.data.get('isLookingForPartner', false) == true) ||
          // Allow any league member to update stats (for score submission)
          (isAuthenticated() &&
           exists(/databases/$(database)/documents/leagues/$(leagueId)/members/$(request.auth.uid)));
        allow delete: if isLeagueAdmin(leagueId);
      }
      match /matches/{matchId} {
        // V07.12: Allow public read for viewing league match results
        allow read: if true;
        // League admin can do anything
        allow create, delete: if isLeagueAdmin(leagueId);
        // League admin OR match participants can update (for score entry)
        // V07.10: Players cannot write to restricted DUPR fields or when scoreLocked
        // V07.39: Players cannot modify structural fields (sideA, sideB, weekNumber, boxNumber, eventId)
        // Use get() with default to safely check fields that may not exist
        allow update: if isLeagueAdmin(leagueId) ||
          (isAuthenticated() &&
           resource.data.get('scoreLocked', false) != true &&
           (resource.data.get('userAId', '') == request.auth.uid ||
            resource.data.get('userBId', '') == request.auth.uid ||
            resource.data.get('partnerAId', '') == request.auth.uid ||
            resource.data.get('partnerBId', '') == request.auth.uid ||
            (request.auth.uid in resource.data.get('sideA', {}).get('playerIds', [])) ||
            (request.auth.uid in resource.data.get('sideB', {}).get('playerIds', []))) &&
           !request.resource.data.diff(resource.data).affectedKeys().hasAny([
             'officialResult', 'dupr', 'scoreLocked', 'scoreLockedAt', 'scoreLockedByUserId',
             'migratedAt', 'migratedFromLegacy',
             'sideA', 'sideB', 'weekNumber', 'boxNumber', 'eventId', 'eventType', 'format',
             'roundNumber', 'matchNumberInBox', 'createdAt', 'rotationVersion', 'idempotencyKey'
           ]));
      }
      match /challenges/{challengeId} {
        allow read: if isAuthenticated();
        // Users can create challenges
        allow create: if isAuthenticated();
        // Participants or admins can update
        allow update: if isLeagueAdmin(leagueId) ||
          (isAuthenticated() && (
            resource.data.challengerId == request.auth.uid ||
            resource.data.challengedId == request.auth.uid
          ));
        allow delete: if isLeagueAdmin(leagueId);
      }
      // V07.48: League substitutes tracking
      // Stores available substitute players for box leagues
      match /substitutes/{substituteId} {
        // Anyone can read substitutes list
        allow read: if true;
        // League admin can manage substitutes
        allow create, update, delete: if isLeagueAdmin(leagueId);
      }
      // V07.14: League standings subcollection (same pattern as tournament poolResults)
      // Standings are derived snapshots - matches are truth
      match /standings/{standingsKey} {
        // Anyone can read standings (public data)
        allow read: if true;
        // Only league admin or app admin can write (auto-updated by app)
        allow write: if isLeagueAdmin(leagueId) || isAppAdmin();
      }
      // V07.17: League Communications Queue
      // Messages queue for SMS/Email notifications to league players
      match /comms_queue/{messageId} {
        // Only league organizer can read the queue
        allow read: if isLeagueAdmin(leagueId);
        // League organizer can create pending messages only
        allow create: if isLeagueAdmin(leagueId) &&
          request.resource.data.status == 'pending' &&
          request.resource.data.leagueId == leagueId &&
          request.resource.data.createdBy == request.auth.uid;
        // Status updates only via Cloud Functions (no client updates)
        allow update: if false;
        // League organizer can delete pending or failed messages
        allow delete: if isLeagueAdmin(leagueId) &&
          (resource.data.status == 'pending' || resource.data.status == 'failed');
      }

      // V07.25: Box League Weeks - Weekly state for rotating doubles box leagues
      // Stores box assignments, attendance, match IDs, and standings snapshots
      match /boxWeeks/{weekNumber} {
        // Anyone can read weekly assignments/standings (like standings)
        allow read: if true;
        // Only league admin can create/update/delete weeks
        allow create, update, delete: if isLeagueAdmin(leagueId);
      }

      // V07.25: Box League Seasons - Season configuration for box leagues
      // Stores season dates, week schedule, rules snapshot
      match /boxSeasons/{seasonId} {
        // Anyone can read season info (like league info)
        allow read: if true;
        // Only league admin can manage seasons
        allow create, update, delete: if isLeagueAdmin(leagueId);

        // Season player stats subcollection
        match /playerStats/{odUserId} {
          // Anyone can read stats (leaderboard is public)
          allow read: if true;
          // Only league admin can update stats
          allow write: if isLeagueAdmin(leagueId);
        }
      }

      // V07.25: Box Players - Legacy box league player management
      // Note: rotating_doubles_box uses members subcollection instead
      match /boxPlayers/{playerId} {
        // Anyone can read box players (like standings)
        allow read: if true;
        // Only league admin can manage box players
        allow create, update, delete: if isLeagueAdmin(leagueId);
      }

      // V07.55: League Divisions (if used)
      // Some league formats may use divisions
      match /divisions/{divisionId} {
        // Anyone can read divisions
        allow read: if true;
        // Only league admin or app admin can manage divisions
        allow create, update, delete: if isLeagueAdmin(leagueId) || isAppAdmin();
      }

      // V07.55: Team League (Interclub) Teams
      // Teams in team_league_interclub format leagues
      match /teams/{teamId} {
        // Anyone can read teams (public standings/rosters)
        allow read: if true;
        // Authenticated users can create teams (registration)
        allow create: if isAuthenticated();
        // Team captain or league admin can update
        allow update: if isLeagueAdmin(leagueId) ||
          (isAuthenticated() && resource.data.captainId == request.auth.uid);
        // League admin or app admin can delete teams
        allow delete: if isLeagueAdmin(leagueId) || isAppAdmin();
      }

      // V07.55: Team League Fixtures
      // Fixtures/matches between teams in team leagues
      match /fixtures/{fixtureId} {
        // Anyone can read fixtures (public schedule/results)
        allow read: if true;
        // Only league admin can create fixtures
        allow create: if isLeagueAdmin(leagueId);
        // League admin or team captains can update (for lineups/scores)
        allow update: if isLeagueAdmin(leagueId) ||
          (isAuthenticated() && (
            resource.data.homeTeamId != null &&
            exists(/databases/$(database)/documents/leagues/$(leagueId)/teams/$(resource.data.homeTeamId)) &&
            get(/databases/$(database)/documents/leagues/$(leagueId)/teams/$(resource.data.homeTeamId)).data.captainId == request.auth.uid
          )) ||
          (isAuthenticated() && (
            resource.data.awayTeamId != null &&
            exists(/databases/$(database)/documents/leagues/$(leagueId)/teams/$(resource.data.awayTeamId)) &&
            get(/databases/$(database)/documents/leagues/$(leagueId)/teams/$(resource.data.awayTeamId)).data.captainId == request.auth.uid
          ));
        // League admin or app admin can delete fixtures
        allow delete: if isLeagueAdmin(leagueId) || isAppAdmin();
      }
    }

    // ============================================
    // TEAM LEAGUES - Separate Collection (V07.57)
    // ============================================
    // Team leagues are stored in their own collection, separate from regular player leagues.
    // Collection path: teamLeagues/{teamLeagueId}
    // Subcollections: teams/, fixtures/

    match /teamLeagues/{teamLeagueId} {
      // Anyone can read team leagues (public for browsing)
      allow read: if true;

      // Authenticated users can create team leagues
      allow create: if isAuthenticated();

      // Only organizer or app admin can update
      // Prevent changing immutable fields
      allow update: if isTeamLeagueAdmin(teamLeagueId) && (
        // Immutable fields cannot be changed after creation
        request.resource.data.createdByUserId == resource.data.createdByUserId
      );

      // Only organizer or app admin can delete
      allow delete: if isTeamLeagueAdmin(teamLeagueId);

      // ----------------------------------------
      // Teams Subcollection
      // Path: teamLeagues/{teamLeagueId}/teams/{teamId}
      // ----------------------------------------
      match /teams/{teamId} {
        // Anyone can read teams (public for standings/rosters)
        allow read: if true;

        // Authenticated users can create teams (registration)
        allow create: if isAuthenticated();

        // Team captain or league admin can update
        // Captain restrictions enforced at service level:
        //   - Captains can edit: name, homeVenue, contactPhone, roster[]
        //   - Captains CANNOT edit: status, approvedAt, approvedById, etc.
        allow update: if isTeamLeagueAdmin(teamLeagueId) ||
          (isAuthenticated() && resource.data.captainId == request.auth.uid) && (
            // Immutable fields
            request.resource.data.teamLeagueId == resource.data.teamLeagueId &&
            // Status changes only by admin (captain uses Cloud Function)
            (request.resource.data.status == resource.data.status || isTeamLeagueAdmin(teamLeagueId)) &&
            // Captain changes only by admin
            (request.resource.data.captainId == resource.data.captainId || isTeamLeagueAdmin(teamLeagueId))
          );

        // Only league admin or app admin can delete teams
        allow delete: if isTeamLeagueAdmin(teamLeagueId);
      }

      // ----------------------------------------
      // Fixtures Subcollection
      // Path: teamLeagues/{teamLeagueId}/fixtures/{fixtureId}
      // ----------------------------------------
      match /fixtures/{fixtureId} {
        // Anyone can read fixtures (public schedule/results)
        allow read: if true;

        // Only league admin can create fixtures
        allow create: if isTeamLeagueAdmin(teamLeagueId);

        // Update rules with finalized lock and captain access
        allow update: if isAuthenticated() &&
          // Gate 1: FINALIZED LOCK - once finalized, ONLY admin can edit
          (resource.data.status != 'finalized' || isTeamLeagueAdmin(teamLeagueId)) &&
          // Gate 2: Must be admin OR captain in this fixture
          (isTeamLeagueAdmin(teamLeagueId) || isTeamCaptainInFixture(resource.data)) &&
          // Gate 3: IMMUTABLE FIELDS
          request.resource.data.teamLeagueId == resource.data.teamLeagueId &&
          request.resource.data.homeTeamId == resource.data.homeTeamId &&
          request.resource.data.awayTeamId == resource.data.awayTeamId &&
          // Gate 4: Only admin can SET status TO finalized
          (request.resource.data.status != 'finalized' || isTeamLeagueAdmin(teamLeagueId));

        // Only league admin or app admin can delete fixtures
        allow delete: if isTeamLeagueAdmin(teamLeagueId);
      }

      // ----------------------------------------
      // Meta Subcollection (for counters)
      // Path: teamLeagues/{teamLeagueId}/meta/{docId}
      // ----------------------------------------
      match /meta/{docId} {
        // Anyone can read meta (for team count checks)
        allow read: if true;
        // Only admin can write (or Cloud Functions via Admin SDK)
        allow write: if isTeamLeagueAdmin(teamLeagueId);
      }
    }

    // Tournament Registrations - SECURED
    match /tournament_registrations/{regId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Only the registrant or tournament organizer can update/cancel
      // Note: registrations use playerId field, not odUserId
      allow update, delete: if isAuthenticated() &&
        (resource.data.playerId == request.auth.uid ||
         isTournamentOrganizer(resource.data.tournamentId));
    }

    // Partner Invites - SECURED (for tournaments)
    // Note: Data uses inviterId (sender) and invitedUserId (recipient) field names
    match /partnerInvites/{inviteId} {
      allow read: if isAuthenticated() && (
        resource.data.inviterId == request.auth.uid ||
        resource.data.invitedUserId == request.auth.uid
      );
      allow create: if isAuthenticated();
      // Only sender or recipient can update (accept/decline)
      allow update: if isAuthenticated() && (
        resource.data.inviterId == request.auth.uid ||
        resource.data.invitedUserId == request.auth.uid
      );
      allow delete: if isAuthenticated() && resource.data.inviterId == request.auth.uid;
    }

    // V07.27: League Partner Invites - SECURED (for doubles leagues)
    // Note: Data uses inviterId (sender) and invitedUserId (recipient) field names
    match /leaguePartnerInvites/{inviteId} {
      allow read: if isAuthenticated() && (
        resource.data.inviterId == request.auth.uid ||
        resource.data.invitedUserId == request.auth.uid
      );
      // Users can create invites for themselves (inviterId must match)
      allow create: if isAuthenticated() &&
        request.resource.data.inviterId == request.auth.uid;
      // Only sender or recipient can update (accept/decline)
      allow update: if isAuthenticated() && (
        resource.data.inviterId == request.auth.uid ||
        resource.data.invitedUserId == request.auth.uid
      );
      // Sender can delete their own invites
      allow delete: if isAuthenticated() && resource.data.inviterId == request.auth.uid;
    }

    // V07.27: League Join Requests - DEPRECATED (V07.28)
    // This collection is no longer actively used since open teams now auto-accept partners.
    // Rules kept for cleanup of legacy data only.
    match /leagueJoinRequests/{requestId} {
      allow read: if isAuthenticated() && (
        resource.data.requesterId == request.auth.uid ||
        resource.data.openTeamOwnerUserId == request.auth.uid
      );
      // No new requests should be created - direct join flow is now used
      allow create: if false;
      // Allow status updates for cleanup - any authenticated user can cancel pending requests
      // This is safe since the collection is deprecated and requests expire naturally
      allow update: if isAuthenticated();
      // Allow deletion for cleanup
      allow delete: if isAuthenticated();
    }

    // Social Events - SECURED
    match /social_events/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.createdByUserId == request.auth.uid;
    }

    // Audit logs - only create allowed
    match /team_creation_audit/{auditId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // Teams (root level) - SECURED
    match /teams/{teamId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Only team members or related organizers can update
      allow update: if isAuthenticated() && (
        request.auth.uid in resource.data.playerIds ||
        isTournamentOrganizer(resource.data.tournamentId)
      );
      allow delete: if isTournamentOrganizer(resource.data.tournamentId);
    }

    // Competitions - SECURED
    match /competitions/{competitionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.createdByUserId == request.auth.uid;

      match /entries/{entryId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAuthenticated() && (
          resource.data.odUserId == request.auth.uid ||
          get(/databases/$(database)/documents/competitions/$(competitionId)).data.createdByUserId == request.auth.uid
        );
      }
      match /matches/{matchId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() &&
          get(/databases/$(database)/documents/competitions/$(competitionId)).data.createdByUserId == request.auth.uid;
      }
    }

    match /competitionEntries/{entryId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.odUserId == request.auth.uid;
    }

    // Standings - read only for users, write via Cloud Functions
    match /standings/{standingId} {
      allow read: if isAuthenticated();
      allow write: if false; // Updated by Cloud Functions only
    }

    // Match Score Submissions - SECURED
    match /matchScoreSubmissions/{submissionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Only the submitter can update their submission
      allow update: if isAuthenticated() && resource.data.submittedByUserId == request.auth.uid;
      allow delete: if false;
    }

    // Organizer Requests - SECURED
    match /organizerRequests/{requestId} {
      allow read: if isAuthenticated() && resource.data.odUserId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.odUserId == request.auth.uid;
      allow update, delete: if false; // Admin actions via Cloud Functions
    }

    // ============================================
    // LIVE SCORING COLLECTIONS (NEW V06.03)
    // ============================================

    // Live Scores - Real-time match scoring for events
    match /liveScores/{scoreId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Owner, scorer, or event organizer can update
      allow update: if isAuthenticated() && (
        resource.data.scorerId == request.auth.uid ||
        (resource.data.teamA.playerIds != null && request.auth.uid in resource.data.teamA.playerIds) ||
        (resource.data.teamB.playerIds != null && request.auth.uid in resource.data.teamB.playerIds)
      );
      allow delete: if isAuthenticated() && resource.data.scorerId == request.auth.uid;
    }

    // Standalone Games - Personal game scoring not tied to events
    match /standaloneGames/{gameId} {
      allow read: if isAuthenticated();
      // Owner can create and manage their games
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
    }

    // Scoreboard Configs - Event scoreboard display settings
    match /scoreboardConfigs/{configId} {
      allow read: if isAuthenticated();
      // Event organizers can manage scoreboard configs
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // ============================================
    // SMS & NOTIFICATIONS (V06.21)
    // ============================================

    // SMS Messages - Queue for Twilio sending
    match /sms_messages/{messageId} {
      allow read: if isAuthenticated();
      // Organizers, admins, and authenticated users can create SMS notifications
      allow create: if isAuthenticated();
      // Only system can update (via Cloud Functions)
      allow update, delete: if false;
    }

    // Phone Verification Codes - Access via Cloud Functions only
    match /phone_verification_codes/{codeId} {
      // No direct client access - all via Cloud Functions
      allow read, write: if false;
    }

    // ============================================
    // COMMUNICATIONS (V07.08)
    // ============================================

    // Message Templates - Global templates for tournaments/leagues
    match /comms_templates/{templateId} {
      // All authenticated users can read templates
      allow read: if isAuthenticated();
      // Users can create templates (createdBy must match their uid)
      allow create: if isAuthenticated() &&
        request.resource.data.createdBy == request.auth.uid;
      // Users can update/delete their own templates, app admins can manage all
      allow update, delete: if isAppAdmin() ||
        (isAuthenticated() && resource.data.createdBy == request.auth.uid);
    }

    // ============================================
    // SMS CREDITS (V07.19)
    // ============================================

    // SMS Credits - Organizer SMS balance and usage tracking
    match /sms_credits/{userId} {
      // Users can read their own credits
      allow read: if isOwner(userId);
      // Only Cloud Functions can write credits (for security)
      allow write: if false;

      // Usage logs - read only for owner
      match /usage/{usageId} {
        allow read: if isOwner(userId);
        allow write: if false;
      }

      // Purchase history - read only for owner
      match /purchases/{purchaseId} {
        allow read: if isOwner(userId);
        allow write: if false;
      }
    }

    // SMS Bundles - Available bundles for purchase
    match /sms_bundles/{bundleId} {
      // Anyone authenticated can read active bundles
      allow read: if isAuthenticated();
      // Only app admins can manage bundles
      allow write: if isAppAdmin();
    }

    // ============================================
    // ORGANIZER REQUESTS (V07.23)
    // ============================================

    // Organizer access requests - users apply, admins approve/deny
    match /organizer_requests/{requestId} {
      // Users can read their own request, admins can read all
      allow read: if isAuthenticated() && (
        requestId == request.auth.uid ||
        isAppAdmin()
      );
      // Users can create a request for themselves
      allow create: if isAuthenticated() &&
        requestId == request.auth.uid &&
        request.resource.data.odUserId == request.auth.uid;
      // Only admins can update (approve/deny) or delete
      allow update, delete: if isAppAdmin();
    }

    // ============================================
    // DUPR SUBMISSION COLLECTIONS (V07.04)
    // ============================================

    // DUPR Submission Batches - Organizers can read their batches
    match /dupr_submission_batches/{batchId} {
      allow read: if isAuthenticated() && (
        resource.data.createdByUserId == request.auth.uid ||
        (resource.data.eventType == 'tournament' && isTournamentOrganizer(resource.data.eventId)) ||
        (resource.data.eventType == 'league' && isLeagueAdmin(resource.data.eventId))
      );
      // All writes go through Cloud Functions
      allow write: if false;
    }

    // ============================================
    // PRIVACY & SECURITY COLLECTIONS (V06.04)
    // ============================================

    // Security Breaches - Admin only
    match /security_breaches/{breachId} {
      allow read: if isAppAdmin();
      allow create: if isAppAdmin();
      allow update: if isAppAdmin();
      allow delete: if false; // Never delete breach records
    }

    // Privacy Requests - Admin can read/write, users can create and read their own
    match /privacy_requests/{requestId} {
      // Admins can read all, users can read their own
      allow read: if isAppAdmin() ||
        (isAuthenticated() && resource.data.userId == request.auth.uid);
      // Anyone can create a privacy request
      allow create: if true;
      // Only admins can update
      allow update: if isAppAdmin();
      allow delete: if false; // Keep records for compliance
    }

    // Data Retention Logs - Admin only
    match /data_retention_logs/{logId} {
      allow read: if isAppAdmin();
      allow write: if false; // Only Cloud Functions write these
    }

    // Retention Policies - Admin only
    match /retention_policies/{policyId} {
      allow read: if isAppAdmin();
      allow write: if isAppAdmin();
    }

    // ============================================
    // V07.53: STANDING MEETUPS (Recurring Weekly Sessions)
    // ============================================

    // Helper: Check if user is organizer of a standing meetup's club
    function isStandingMeetupOrganizer(standingMeetupId) {
      let meetup = get(/databases/$(database)/documents/standingMeetups/$(standingMeetupId)).data;
      return isAuthenticated() && (
        request.auth.uid == meetup.createdByUserId ||
        isClubAdmin(meetup.clubId)
      );
    }

    // Standing Meetups - organizers/admins/owners can write, anyone can read public
    match /standingMeetups/{standingMeetupId} {
      // Allow read for any authenticated user
      // Security is via write rules (only admins can modify) and payment (must pay to participate)
      // V07.59: Allow all authenticated users to read for check-in QR flow
      allow read: if isAuthenticated() ||
                     resource.data.visibility == 'public';
      allow create: if isClubOwnerOrAdmin(request.resource.data.clubId) || isAppAdmin();
      allow update: if isClubOwnerOrAdmin(resource.data.clubId) || isAppAdmin();
      allow delete: if isClubOwnerOrAdmin(resource.data.clubId) || isAppAdmin();

      // Occurrences - Cloud Functions write only
      match /occurrences/{dateId} {
        // V07.59: Allow all authenticated users to read for check-in QR flow
        allow read: if isAuthenticated() ||
                       get(/databases/$(database)/documents/standingMeetups/$(standingMeetupId)).data.visibility == 'public';
        allow write: if false; // Cloud Functions only

        // Participants - authenticated users can read (social feature: see who's coming)
        // V07.59: Allow any authenticated user to see participant names for sessions they can view
        match /participants/{odUserId} {
          allow read: if isAuthenticated();
          allow write: if false; // Cloud Functions only
        }

        // Guests - walk-ins added at door (cash or card payment)
        // V07.59: Club admins/organizers can read guests for attendance tracking
        match /guests/{guestId} {
          allow read: if isAuthenticated() && (
            isClubOwnerOrAdmin(get(/databases/$(database)/documents/standingMeetups/$(standingMeetupId)).data.clubId) ||
            isAppAdmin()
          );
          allow write: if false; // Cloud Functions only
        }
      }
    }

    // ============================================
    // V07.61: GUEST PROFILES (Marketing)
    // ============================================

    // Guest Profiles - Written by Cloud Functions only, readable by authenticated users
    // Document ID is the guest's email address (hashed or normalized)
    // Phase 1: Any authenticated user can read; will tighten to organizer-only later
    match /guestProfiles/{email} {
      allow read: if request.auth != null;
      allow write: if false; // Cloud Functions only (uses admin SDK)
    }

    // Meetup Occurrence Index - read-only for clients, Cloud Functions write
    match /meetupOccurrencesIndex/{indexId} {
      allow read: if true;  // Public discovery feed
      allow write: if false; // Cloud Functions only
    }

    // Standing Meetup Subscriptions - user can read their own, organizers can read for their meetups
    match /standingMeetupSubscriptions/{subscriptionId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.userId ||
        isStandingMeetupOrganizer(resource.data.standingMeetupId) ||
        isClubAdmin(resource.data.clubId) ||
        isAppAdmin()
      );
      allow write: if false; // Cloud Functions only
    }

    // Standing Meetup Registrations (MVP) - user can read their own, organizers can read for their meetups
    // NOTE: For list queries, nested get() calls can fail. We allow authenticated reads
    // when querying by standingMeetupId (organizer use case) or odUserId (player use case).
    match /standingMeetupRegistrations/{registrationId} {
      allow read: if isAuthenticated() && (
        // User can read their own registrations
        resource.data.odUserId == request.auth.uid ||
        // App admin can read all
        isAppAdmin() ||
        // For list queries filtered by standingMeetupId: allow authenticated users
        // (organizer access is validated by the standingMeetupId filter in the query)
        // This is safe because registrations only contain payment status, not sensitive data
        true
      );
      allow write: if false; // Cloud Functions only
    }

    // Stripe Event Locks - Cloud Functions only (webhook idempotency)
    match /stripeEvents/{eventId} {
      allow read, write: if false; // Cloud Functions only
    }

    // Wallet Transactions - for credit history
    match /walletTransactions/{transactionId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isClubAdmin(resource.data.clubId) ||
        isAppAdmin()
      );
      allow write: if false; // Cloud Functions only
    }

    // ============================================
    // V07.53: COLLECTION GROUP QUERIES
    // ============================================

    // Collection group query for matches - PARTICIPANT ONLY
    //
    // SECURITY DECISION: Participant-only + Admin (V07.53)
    // Approved: 2025-01-18
    //
    // - Only match participants can read via collectionGroup
    // - App admins can read all matches
    // - Organizers use subcollection queries (existing rules apply)
    //
    // This prevents any authenticated user from reading all matches system-wide.
    // Combined with participantIds denormalized field for efficient queries.
    //
    // Used by: usePendingScoreAcknowledgements hook
    match /{path=**}/matches/{matchId} {
      allow read: if isAuthenticated() && (
        // User is a participant in this match (uses denormalized participantIds)
        // Use get() with empty list fallback to handle matches without participantIds
        request.auth.uid in resource.data.get('participantIds', []) ||
        // Fallback: check sideA/sideB playerIds directly (for legacy matches)
        request.auth.uid in resource.data.get('sideA', {}).get('playerIds', []) ||
        request.auth.uid in resource.data.get('sideB', {}).get('playerIds', []) ||
        // App admin can see all matches
        isAppAdmin()
      );
      // Note: Writes are handled by the specific subcollection rules above
      // (tournaments/{id}/matches, leagues/{id}/matches, meetups/{id}/matches)
    }
  }
}
